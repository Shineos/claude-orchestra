# Y機能（タスク分解確認フロー）使用方法

## 概要

Y機能は、`orch add` コマンドでタスクを追加した際に、AIが自動的にタスクを分解し、ユーザーがその分解プランを確認・承認・修正できる対話的なフローです。

**特徴:**
- 🤖 AIがタスクを自動的に適切なサブタスクに分解
- 👤 分解結果をユーザーが確認して承認可能
- 🔄 最大3回まで再分解をリクエスト可能
- ✏️ 手動編集モードでJSONを直接編集可能
- ❌ キャンセルして何もしないことも可能

## 基本的な使用フロー

### 1. タスク追加コマンド実行

```bash
orch add "ユーザー認証機能の実装"
```

### 2. AIによるタスク分解

システムがClaude AIを使用してタスクを分析し、サブタスクに分解します。

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  タスク自動振り分け (AI Mode: true)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

元のタスク: ユーザー認証機能の実装

AIでタスクを分析中...
```

### 3. 分解プランの表示

AIが提案したサブタスクが一覧表示されます。

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  タスク分解プラン
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

元のタスク:
  ユーザー認証機能の実装

提案されたサブタスク (4個):

[1] ログインフォームのUI実装
    担当: Frontend
    理由: ユーザーインターフェースの実装が必要です

[2] 認証APIの実装（POST /api/auth/login）
    担当: Backend
    理由: サーバーサイドの認証ロジックが必要です

[3] セッション管理（JWT/Cookie）
    担当: Backend
    理由: 認証状態の管理が必要です

[4] 認証機能のテスト作成
    担当: Tests
    理由: 品質保証のためテストが必要です
```

### 4. 確認プロンプト

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
このプランで進めますか？

  Y - このプランを承認
  N - 拒否して再分解
  E - 手動で編集
  Q - キャンセル

選択:
```

## 選択肢の詳細

### **Y** - プランの承認

提案されたプランを承認し、タスクを作成します。

**実行例:**
```bash
選択: Y
✓ 4個のタスクを作成しました
```

**効果:**
- サブタスクが `.claude/tasks.json` に登録されます
- 各サブタスクに自動的にタスクIDが割り当てられます
- 関連するエージェントが自動でwatchモードとして起動します

### **N** - 再分解をリクエスト

プランを拒否し、AIに再分解を指示します。フィードバックを提供することで、より良い分解結果を得ることができます。

**実行例:**
```bash
選択: N

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  フィードバック収集
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

どのように改善すればよいですか？

  1. サブタスクを追加する
  2. サブタスクを削除する
  3. エージェントの割り当てを変更する
  4. サブタスクの説明を変更する
  5. 自由形式のフィードバック

選択: 5
自由形式のフィードバックを入力してください:
セキュリティ考慮として、パスワードハッシュ化とCSRF対策のタスクを追加してください

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  タスク分解プラン（再試行 1/3）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**フィードバックオプション:**

| オプション | 説明 | 入力例 |
|-----------|------|--------|
| 1 | サブタスクを追加 | 「パスワードリセット機能を追加」 |
| 2 | サブタスクを削除 | 「3」 |
| 3 | エージェント割り当て変更 | サブタスク番号「2」、新しいエージェント「frontend」 |
| 4 | 説明を変更 | サブタスク番号「1」、新しい説明「モダンなログインUI」 |
| 5 | 自由形式のフィードバック | 「セキュリティ対策を強化して」 |

**重要:**
- 最大3回まで再試行可能
- 3回とも承認されない場合、ルールベースの分解にフォールバック

### **E** - 手動編集モード

JSON形式の分解結果を直接編集できます。

**実行例:**
```bash
選択: E

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  手動編集モード
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

現在の分解結果:

{
  "subtasks": [
    {
      "description": "ログインフォームのUI実装",
      "agent": "frontend",
      "rationale": "ユーザーインターフェースの実装が必要です",
      "dependencies": []
    },
    ...
  ]
}

編集手順:
  1. 上記のJSONをコピーしてエディタで編集してください
  2. 編集したJSONを貼り付けてEnterを押してください
  3. 空行を入力すると編集完了です

編集後のJSON:
```

**編集時の注意点:**
- JSON形式が有効である必要があります
- `subtasks` 配列が必須です
- 各サブタスクには `description`, `agent`, `rationale` が必須です
- `dependencies` は空配列 `[]` でも可

**編集例:**
```json
{
  "subtasks": [
    {
      "description": "ログインフォームのUI実装（モダンデザイン）",
      "agent": "frontend",
      "rationale": "ユーザーインターフェースの実装が必要です",
      "dependencies": []
    },
    {
      "description": "認証APIの実装",
      "agent": "backend",
      "rationale": "サーバーサイドの認証ロジックが必要です",
      "dependencies": []
    },
    {
      "description": "パスワードハッシュ化機能",
      "agent": "backend",
      "rationale": "セキュリティのためパスワードをハッシュ化",
      "dependencies": [1]
    }
  ]
}
```

### **Q** - キャンセル

操作をキャンセルし、何もしません。

**実行例:**
```bash
選択: Q
操作をキャンセルしました
```

## 依存関係について

サブタスク間の依存関係を指定できます。依存関係が設定されたタスクは、依存先のタスクが完了するまで実行されません。

**依存関係の指定例:**

```json
{
  "subtasks": [
    {
      "description": "データベーススキーマ設計",
      "agent": "backend",
      "dependencies": []
    },
    {
      "description": "ユーザーモデル実装",
      "agent": "backend",
      "dependencies": [0]  // タスク[0]に依存
    },
    {
      "description": "ユーザーAPI実装",
      "agent": "backend",
      "dependencies": [1]  // タスク[1]に依存
    }
  ]
}
```

**実行順序:**
1. タスク[0]: データベーススキーマ設計 → 完了
2. タスク[1]: ユーザーモデル実装（タスク[0]完了後に実行可能）
3. タスク[2]: ユーザーAPI実装（タスク[1]完了後に実行可能）

## エージェント種別

| エージェント | 役割 | 判定キーワード例 |
|------------|------|-----------------|
| **Frontend** | UI/UX実装 | UI, 画面, コンポーネント, スタイル, フォーム, css, react, vue |
| **Backend** | API/DB/認証 | API, サーバー, データベース, 認証, ログイン, モデル, スキーマ |
| **Tests** | テスト | テスト, スペック, カバレッジ, 単体テスト, 結合テスト, e2e |
| **Docs** | ドキュメント | ドキュメント, README, 仕様書, マニュアル, ガイド, APIドキュメント |

## 自動確認モード

環境変数 `ORCH_AUTO_CONFIRM=yes` を設定すると、確認フローをスキップして自動承認します。

```bash
export ORCH_AUTO_CONFIRM=yes
orch add "ユーザー認証機能の実装"
# → 確認なしで自動的に最初のプランが承認されます
```

**使用シーン:**
- CI/CDパイプライン内での実行
- スクリプト化されたタスク登録
- 対話的な確認が不要な場合

## トラブルシューティング

### AI分解が失敗した場合

AIによる分解が失敗すると、自動的にルールベースの分解にフォールバックします。

```
AI分解に失敗しました。ルールベースを使用します...
```

**ルールベースの分解パターン:**
- 認証機能 → 6個のサブタスク（UI、API、セッション、テスト×2、ドキュメント）
- ユーザー登録 → 5個のサブタスク
- データベース → 5個のサブタスク
- API → 5個のサブタスク

### 入力が読み取られない

パイプ経由で入力されている場合、`/dev/tty` から読み取るよう自動的に切り替わります。

```bash
echo "テスト追加" | orch add "新機能"
# → /dev/tty から確認入力を読み取ります
```

### 無効なJSONを編集した場合

手動編集モードで無効なJSONを入力した場合:

```
編集内容が無効です (invalid_json)
```

正しいJSON形式で再度入力してください。

## 実行完了後のフロー

**Y**で承認後:

```
✓ 4個のタスクを作成しました

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  タスク作成完了
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

作成されたタスク:
  [1] ログインフォームのUI実装
      → エージェント: Frontend
      → ステータス: pending

  [2] 認証APIの実装
      → エージェント: Backend
      → ステータス: pending

  [3] セッション管理
      → エージェント: Backend
      → ステータス: pending

  [4] 認証機能のテスト作成
      → エージェント: Tests
      → ステータス: pending

エージェントを自動起動します...
```

その後、エージェントが自動でwatchモードとして起動し、タスクを連続実行します。

## 関連コマンド

| コマンド | 説明 |
|---------|------|
| `orch status` | タスク状況を確認 |
| `orch list` | 実行中のエージェント一覧 |
| `orch monitor` | リアルタイムモニタリング |
| `orch next` | 次に実行可能なタスク表示 |

## 関連ドキュメント

- [API仕様書](./y-feature-api-spec.md) - 開発者向けAPI仕様
- [承認機能使用方法](./approval-usage.md) - 承認ワークフローの詳細
- [システム仕様書](./specification.md) - 全体アーキテクチャ
