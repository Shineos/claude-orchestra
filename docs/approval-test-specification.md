# 承認テスト仕様書 (Approval Test Specification)

## 概要

本ドキュメントは、Claude Code マルチエージェントシステムにおける**承認ワークフロー機能**のテスト要件とテストシナリオを定義するものです。

### テストの目的

承認ワークフロー機能の品質を保証し、以下を検証します：

1. **機能性**: 承認フローが設計通りに動作すること
2. **信頼性**: エッジケースやエラー状態でも正しく動作すること
3. **セキュリティ**: 不正な承認操作を防止できること
4. **ユーザビリティ**: 承認操作が直感的で分かりやすいこと

---

## 1. 機能要件

### 1.1 承認リクエストの作成

| 要件ID | 説明 | 優先度 |
|--------|------|--------|
| AR-01 | エージェントがタスク完了時に承認リクエストを自動作成できる | Critical |
| AR-02 | 承認リクエストには変更内容（diff）を含める | Critical |
| AR-03 | 承認リクエストには期限（timeout）を設定できる | High |
| AR-04 | 承認リクエストには承認者情報を含める | High |
| AR-05 | 承認リクエストは一意のIDで識別される | Critical |

### 1.2 承認ステータス管理

| 要件ID | 説明 | 優先度 |
|--------|------|--------|
| AS-01 | 承認リクエストのステータスは `pending`, `approved`, `rejected`, `timeout` を持つ | Critical |
| AS-02 | ステータス変更は永続化される | Critical |
| AS-03 | ステータス変更時にタイムスタンプを記録する | High |
| AS-04 | ステータス変更時に実行者を記録する | High |

### 1.3 承認操作

| 要件ID | 説明 | 優先度 |
|--------|------|--------|
| AO-01 | 承認者はリクエストを承認できる | Critical |
| AO-02 | 承認者はリクエストを却下できる | Critical |
| AO-03 | 却下時には理由を入力できる | High |
| AO-04 | 承認/却下後のリクエストは変更不可とする | Critical |
| AO-05 | 期限切れのリクエストは操作不可とする | High |

### 1.4 通知機能

| 要件ID | 説明 | 優先度 |
|--------|------|--------|
| NF-01 | 新規承認リクエスト作成時に通知する | High |
| NF-02 | 承認/却下時にリクエスト作成者に通知する | High |
| NF-03 | 期限切れ間近でアラート通知する | Medium |

---

## 2. 非機能要件

### 2.1 パフォーマンス

| 要件ID | 説明 | 基準値 |
|--------|------|--------|
| PF-01 | 承認リクエスト作成のレスポンス時間 | < 100ms |
| PF-02 | 承認操作のレスポンス時間 | < 100ms |
| PF-03 | 承認一覧表示のレスポンス時間 | < 500ms |

### 2.2 同時実行性

| 要件ID | 説明 | 基準値 |
|--------|------|--------|
| CC-01 | 複数ユーザーによる同時承認操作を正しく処理 | デッドロックなし |
| CC-02 | 同一リクエストへの同時操作を排他制御 | 最後の操作が有効 |

### 2.3 セキュリティ

| 要件ID | 説明 | 基準値 |
|--------|------|--------|
| SC-01 | 承認権限のないユーザーは操作不可 | 403エラー |
| SC-02 | 承認操作の監査ログを記録 | すべての操作 |

---

## 3. テストシナリオ

### 3.1 ユニットテストシナリオ

#### UT-01: 承認リクエスト作成

| ID | テストケース | 入力 | 期待結果 |
|----|-------------|------|----------|
| UT-01-01 | 正常系：最小構成で作成 | タスクID, 変更内容 | ステータス`pending`で作成される |
| UT-01-02 | 正常系：期限付きで作成 | タスクID, 変更内容, 期限=3600秒 | 期限が正しく設定される |
| UT-01-03 | 正常系：承認者指定 | タスクID, 変更内容, 承認者ID | 承認者が正しく設定される |
| UT-01-04 | 異常系：必須項目欠損 | タスクIDのみ | エラーが返される |
| UT-01-05 | 異常系：無効な期限 | 期限=-1 | エラーが返される |

#### UT-02: ステータス変更

| ID | テストケース | 入力 | 期待結果 |
|----|-------------|------|----------|
| UT-02-01 | 正常系：pending → approved | 承認操作 | ステータスが`approved`になる |
| UT-02-02 | 正常系：pending → rejected | 却下操作 | ステータスが`rejected`になる |
| UT-02-03 | 正常系：タイムスタンプ記録 | 承認操作 | `completed_at`が記録される |
| UT-02-04 | 異常系：approved → rejected | 却下操作 | エラーが返される（不可逆） |
| UT-02-05 | 異常系：重複操作 | 2回承認操作 | 2回目はエラーが返される |

#### UT-03: タイムアウト処理

| ID | テストケース | 入力 | 期待結果 |
|----|-------------|------|----------|
| UT-03-01 | 正常系：期限切れ検出 | 期限経過後のリクエスト | ステータスが`timeout`になる |
| UT-03-02 | 正常系：期限切れ後の操作拒否 | 期限切れリクエストを承認 | エラーが返される |
| UT-03-03 | 正常系：期限切れ通知 | 期限切れイベント | 通知が送信される |

---

### 3.2 結合テストシナリオ

#### IT-01: 基本的な承認フロー

```gherkin
Feature: 承認リクエストのライフサイクル

  Scenario: エージェントが完了したタスクを承認する
    Given エージェントがタスク#123を完了する
    And タスク完了時に承認リクエストが自動作成される
    When 承認者が一覧画面を表示する
    Then 承認リクエスト#456が"pending"で表示される
    When 承認者が「承認」ボタンをクリックする
    Then リクエスト#456のステータスが"approved"になる
    And エージェントに完了通知が送信される
```

#### IT-02: 承認却下フロー

```gherkin
Feature: 承認却下

  Scenario: 承認者がリクエストを却下する
    Given 承認リクエスト#789が"pending"状態
    When 承認者が「却下」ボタンをクリックする
    And 却下理由に"実装方針が異なる"と入力する
    Then リクエスト#789のステータスが"rejected"になる
    And 却下理由が記録される
    And エージェントに却下通知が送信される
```

#### IT-03: タイムアウトフロー

```gherkin
Feature: 自動タイムアウト

  Scenario: 期限切れでリクエストが自動的にタイムアウトする
    Given 承認リクエスト#101の期限が1時間後に設定されている
    And 1時間が経過する
    When タイムアウトチェックが実行される
    Then リクエスト#101のステータスが"timeout"になる
    And エージェントに期限切れ通知が送信される
```

#### IT-04: 依存タスクの連鎖承認

```gherkin
Feature: 依存関係を考慮した承認

  Scenario: タスクAが完了し、依存するタスクBが自動開始される
    Given タスク#1（Frontend実装）が承認待ち
    And タスク#2（Backend実装）がタスク#1に依存
    When タスク#1が承認される
    Then タスク#1が"completed"になる
    And タスク#2が"pending"から"in_progress"に遷移する
```

---

### 3.3 E2Eテストシナリオ

#### E2E-01: 承認待ち一覧からの承認操作

| 手順 | 操作 | 期待結果 |
|------|------|----------|
| 1 | エージェントがファイル変更を含むタスクを完了 | 承認リクエストが作成される |
| 2 | 承認者がCLIで `orch approvals` を実行 | 承認待ち一覧が表示される |
| 3 | 変更diffが正しく表示されることを確認 | 変更内容が可視化されている |
| 4 | `orch approve <id>` を実行 | 承認完了メッセージが表示される |
| 5 | `orch status` でタスク状況を確認 | タスクが"completed"になっている |

#### E2E-02: Web UIでの承認操作（将来実装）

| 手順 | 操作 | 期待結果 |
|------|------|----------|
| 1 | ブラウザでダッシュボードを開く | 承認待ちバッジが表示される |
| 2 | 承認待ちページを開く | リストが表示される |
| 3 | リクエストをクリックして詳細を表示 | diffがハイライト表示される |
| 4 | 「承認」ボタンをクリック | 確認ダイアログが表示される |
| 5 | 確認して承認 | ステータスが「承認済み」に変わる |

#### E2E-03: エージェントの自動再開

| 手順 | 操作 | 期待結果 |
|------|------|----------|
| 1 | 依存関係のあるタスクA（承認待ち）、タスクB（待機中）を作成 | タスクBが依存待ち状態 |
| 2 | タスクAを却下する | タスクAが"rejected"になる |
| 3 | エージェントがタスクAを修正して再提出 | 新しい承認リクエストが作成される |
| 4 | タスクAを承認する | タスクAが"completed"になる |
| 5 | エージェントが自動的にタスクBを開始 | タスクBが"in_progress"になる |

---

### 3.4 エッジケーステストシナリオ

#### EC-01: 同時承認操作

| ID | シナリオ | 期待結果 |
|----|----------|----------|
| EC-01-01 | 2人の承認者が同時に同一リクエストを承認 | 最後の操作が有効になる（楽観的ロック） |
| EC-01-02 | 承認と却下が同時に実行される | デッドロックせず、どちらかが有効になる |
| EC-01-03 | 承認操作中に期限切れが発生 | 操作が拒否され、期限切れエラーが返る |

#### EC-02: 権限管理

| ID | シナリオ | 期待結果 |
|----|----------|----------|
| EC-02-01 | 承認権限のないユーザーが承認を試行 | 403 Forbidden エラー |
| EC-02-02 | リクエスト作成者が自分のリクエストを承認 | 自己承認は許可されない（設定次第） |
| EC-02-03 | 管理者権限で期限切れリクエストを操作 | 管理者は操作可能（設定次第） |

#### EC-03: データ整合性

| ID | シナリオ | 期待結果 |
|----|----------|----------|
| EC-03-01 | 承認中にシステムがクラッシュ | 再起動後にリクエストが復元される |
| EC-03-02 | 承認リクエストの関連タスクが削除される | リクエストも削除されるか、 orphan としてマーク |
| EC-03-03 | 大量の承認リクエストが作成される | ページネーションで正しく表示される |

---

## 4. テストデータ

### 4.1 テストユーザー

| ユーザーID | 役割 | 権限 |
|-----------|------|------|
| user_admin | 管理者 | すべての承認操作、管理機能 |
| user_approver | 承認者 | 承認/却下操作 |
| user_developer | 開発者 | リクエスト作成、自己閲覧のみ |
| user_guest | ゲスト | 閲覧のみ |

### 4.2 テストフィクスチャ

#### 承認リクエストのサンプルデータ

```json
{
  "id": "test-approval-001",
  "task_id": 123,
  "agent": "frontend",
  "status": "pending",
  "created_at": "2026-02-07T10:00:00Z",
  "expires_at": "2026-02-07T11:00:00Z",
  "requester": "user_developer",
  "assignee": "user_approver",
  "changes": {
    "files": [
      {
        "path": "src/components/AuthForm.tsx",
        "diff": "@@ -1,5 +1,10 @@\n+function Login() {\n+  return <form />\n+}"
      }
    ]
  }
}
```

---

## 5. テスト実施計画

### 5.1 テストフェーズ

| フェーズ | 内容 | 期間 | 担当 |
|---------|------|------|------|
| Phase 1 | ユニットテスト実装 | 2日 | Tests Agent |
| Phase 2 | 結合テスト実装 | 3日 | Tests Agent |
| Phase 3 | E2Eテスト実装 | 3日 | Tests Agent |
| Phase 4 | エッジケース追加 | 2日 | Tests Agent |
| Phase 5 | レポート作成 | 1日 | Docs Agent |

### 5.2 テストカバレッジ目標

| 種類 | 目標カバレッジ |
|------|--------------|
| ステートメントカバレッジ | 80%以上 |
| ブランチカバレッジ | 70%以上 |
| 機能カバレッジ | 100% |

---

## 6. 成功基準

### 6.1 テスト成功基準

- [ ] すべてのユニットテストが passing である
- [ ] すべての結合テストが passing である
- [ ] すべての E2E テストシナリオが正常に実行できる
- [ ] エッジケーステストで重大なバグが見つからない
- [ ] テストカバレッジが目標値を達成している

### 6.2 品質基準

- [ ] 承認操作のレスポンス時間が100ms以内
- [ ] 同時実行テストでデッドロックが発生しない
- [ ] 権限なしの操作がすべて拒否される
- [ ] 期限切れリクエストが正しく処理される

---

## 7. 用語集

| 用語 | 説明 |
|------|------|
| **承認リクエスト (Approval Request)** | エージェントの作業結果に対する承認を求める要求 |
| **承認者 (Approver)** | 承認リクエストを審査し、承認/却下を行う権限を持つユーザー |
| **diff（差分）** | 変更前後のファイル内容の差異情報 |
| **timeout（期限切れ）** | 設定された期限内に承認が行われなかった状態 |
| **pending（承認待ち）** | リクエスト作成直後で、まだ審査されていない状態 |
| **approved（承認済み）** | 承認者によって承認された状態 |
| **rejected（却下）** | 承認者によって却下された状態 |
| **orphan（孤立）** | 関連するタスクが削除された承認リクエスト |

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|----------|--------|
| 2026-02-07 | 1.0 | 初版作成 | Docs Agent |

---

## 参考資料

- [README.md](../README.md) - システム全体の概要
- [specification.md](./specification.md) - システム仕様書
- Task #7: 承認テストの要件とシナリオを定義
