# 承認ワークフロー使用ガイド

## 概要

承認ワークフロー機能を使用すると、エージェントが完了したタスクを承認プロセスを経てから「完了」としてマークできます。これにより、コード変更や重要な決定を確認・承認できるようになります。

## コマンド一覧

### 承認リクエストの表示

```bash
# すべての承認リクエストを一覧表示
orch approvals

# 特定の承認リクエストの詳細を表示
orch approval <request_id>
```

**例:**
```bash
orch approvals              # すべてのリクエストを表示
orch approval 1             # リクエスト #1 の詳細を表示
```

### 承認操作

```bash
# リクエストを承認
orch approve <request_id>

# リクエストを却下（理由必須）
orch reject <request_id> --reason "理由"
```

**例:**
```bash
orch approve 1                          # リクエスト #1 を承認
orch reject 2 --reason "実装方針が異なる"  # リクエスト #2 を却下
```

## UI要素と画面

### 1. 承認リクエスト一覧画面

`orch approvals` コマンドで表示される画面には以下が含まれます：

**サマリー情報:**
- 全体の承認リクエスト数
- 承認待ちの数
- 承認済みの数
- 却下された数
- 期限切れの数

**リクエスト詳細:**
- 各リクエストの一覧（ID、エージェント、タスク、説明、状態、期限）

**ステータスアイコン:**
- ⏳ (黄色): 承認待ち (pending)
- ✓ (緑色): 承認済み (approved)
- ✗ (赤色): 却下 (rejected)
- ⏱ (赤色): 期限切れ (timeout)

### 2. 承認リクエスト詳細画面

`orch approval <id>` コマンドで表示される画面には以下が含まれます：

**基本情報:**
- 承認リクエストID
- 関連するタスクID
- 担当エージェント
- 説明
- 現在のステータス
- 作成日時
- 期限

**変更内容:**
- 変更されたファイルのパス
- diff（差分）表示

## ワークフロー例

### 基本的な承認フロー

1. **エージェントがタスクを完了**
   ```bash
   # エージェントがタスクを完了すると、自動的に承認リクエストが作成されます
   ```

2. **承認リクエストを確認**
   ```bash
   orch approvals
   ```

3. **詳細を確認**
   ```bash
   orch approval 1
   ```

4. **承認または却下**
   ```bash
   # 承認する場合
   orch approve 1
   
   # 却下する場合
   orch reject 1 --reason "修正が必要です"
   ```

### 期限切れの処理

承認リクエストには期限が設定されています。期限が切れると：

- ステータスが「期限切れ」に変わります
- 承認や却下ができなくなります
- 関連するタスクは自動的に失敗としてマークされます

## 承認テストシナリオ

承認機能のテストに使用できるサンプルデータが `.claude/approvals.json` に含まれています：

1. **承認待ちリクエストの表示**
   ```bash
   orch approvals
   ```

2. **詳細情報の確認**
   ```bash
   orch approval 1  # フロントエンドのログイン画面UI
   orch approval 2  # バックエンドの認証API
   ```

3. **承認操作のテスト**
   ```bash
   orch approve 1  # 正常に承認されるはず
   ```

4. **却下操作のテスト**
   ```bash
   orch reject 2 --reason "セキュリティ対策が不十分"
   ```

## トラブルシューティング

### エラー: 承認リクエストが見つかりません

指定したIDの承認リクエストが存在しないか、既に処理されています。

```bash
orch approvals  # 存在するリクエストを確認
```

### エラー: このリクエストは既に承認済みです

既に承認または却下されたリクエストを操作しようとしています。

### エラー: このリクエストは期限切れです

設定された期限を過ぎているため、操作できません。新しいリクエストを作成する必要があります。

## データ構造

承認リクエストは `.claude/approvals.json` に保存されます：

```json
{
  "approvals": [
    {
      "id": 1,
      "task_id": 100,
      "agent": "frontend",
      "description": "ログイン画面UI実装",
      "status": "pending",
      "created_at": "2026-02-07T10:00:00Z",
      "expires_at": "2026-02-08T10:00:00Z",
      "completed_at": null,
      "changes": {
        "files": [
          {
            "path": "src/components/LoginForm.tsx",
            "diff": "..."
          }
        ]
      }
    }
  ],
  "last_id": 1
}
```

## 統合

承認機能は以下と統合されています：

- **タスク管理**: タスク完了時の承認フロー
- **ログシステム**: 承認操作のログ記録
- **エージェントシステム**: 各エージェントの承認リクエスト管理

